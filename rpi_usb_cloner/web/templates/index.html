<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rpi USB Cloner</title>
  <link rel="stylesheet" href="/static/tabler/tabler.min.css" />
  <style>
    @font-face {
      font-family: 'Lucide';
      src: url('/ui-assets/fonts/lucide.ttf') format('truetype');
      font-display: swap;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .lucide-icon {
      font-family: 'Lucide';
      font-size: 1.1em;
      line-height: 1;
    }
    .lucide-icon::before {
      display: inline-block;
    }
    .lucide-icon-tv::before {
      content: "\e203";
    }
    .lucide-icon-logs::before {
      content: "\e5f4";
    }
    .lucide-icon-copy-plus::before {
      content: "\e3fd";
    }
    /* D-pad on the left */
    .dpad-container {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .dpad-svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .dpad-cross {
      fill: #000;
    }
    .dpad-arrow {
      fill: #fff;
      transition: fill 0.15s ease;
    }
    .dpad-container:has(.dpad-up:hover) .dpad-arrow-up {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-down:hover) .dpad-arrow-down {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-left:hover) .dpad-arrow-left {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-right:hover) .dpad-arrow-right {
      fill: #ff4d4f;
    }
    .dpad-btn {
      position: absolute;
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .dpad-up {
      width: 60px;
      height: 70px;
      left: 60px;
      top: 0;
    }
    .dpad-down {
      width: 60px;
      height: 70px;
      left: 60px;
      bottom: 0;
    }
    .dpad-left {
      width: 70px;
      height: 60px;
      left: 0;
      top: 60px;
    }
    .dpad-right {
      width: 70px;
      height: 60px;
      right: 0;
      top: 60px;
    }
    /* Action buttons on the right */
    .action-buttons {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .btn-ok {
      position: absolute;
      top: 0;
      right: 0;
    }
    .btn-back {
      position: absolute;
      bottom: 0;
      left: 0;
    }
    .action-btn {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      padding: 0;
      background: transparent;
    }
    .action-btn svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .action-btn circle {
      fill: #000;
      transition: fill 0.15s ease, filter 0.15s ease;
    }
    .action-btn text {
      fill: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 0.5px;
      transition: fill 0.15s ease;
    }
    .action-btn:hover circle {
      fill: #000;
    }
    .action-btn:hover text {
      fill: #ff4d4f;
    }
    .action-btn:active circle {
      fill: #000;
    }
    #screen {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="navbar navbar-expand-md d-print-none">
      <div class="container-xl">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#" aria-label="Rpi USB Cloner">
          <span class="lucide-icon lucide-icon-copy-plus" aria-hidden="true"></span>
          <span>Rpi USB CLONER</span>
        </a>
        <div class="navbar-nav flex-row order-md-last ms-auto align-items-center">
          <div class="nav-item">
            <span class="nav-link d-flex align-items-center small" id="status">
              <span class="status status-red"><span class="status-dot"></span>Disconnected</span>
            </span>
          </div>
        </div>
      </div>
    </header>
    <div class="page-wrapper">
      <div class="page-body">
        <div class="container-xl">
          <div class="row row-cards">
            <div class="col-12 col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <span class="lucide-icon lucide-icon-tv" aria-hidden="true"></span>
                    Preview
                  </h3>
                </div>
                <div class="card-body">
                  <div class="ratio ratio-2x1 mb-4">
                    <canvas id="screen" class="w-100 h-100 d-block" width="128" height="64"></canvas>
                  </div>
                  <div class="row g-4 justify-content-between align-items-center">
                    <div class="col-12 col-md-6 d-flex justify-content-center">
                      <div class="dpad-container">
                        <svg class="dpad-svg" viewBox="0 0 200 200" aria-hidden="true" focusable="false">
                          <path class="dpad-cross" d="M78 20h44a8 8 0 0 1 8 8v42h42a8 8 0 0 1 8 8v44a8 8 0 0 1-8 8h-42v42a8 8 0 0 1-8 8H78a8 8 0 0 1-8-8v-42H28a8 8 0 0 1-8-8V78a8 8 0 0 1 8-8h42V28a8 8 0 0 1 8-8z" />
                          <path class="dpad-arrow dpad-arrow-up" d="M100 38l12 20H88z" />
                          <path class="dpad-arrow dpad-arrow-down" d="M100 162l-12-20h24z" />
                          <path class="dpad-arrow dpad-arrow-left" d="M38 100l20-12v24z" />
                          <path class="dpad-arrow dpad-arrow-right" d="M162 100l-20 12V88z" />
                        </svg>
                        <button class="dpad-btn dpad-up" data-button="UP"></button>
                        <button class="dpad-btn dpad-down" data-button="DOWN"></button>
                        <button class="dpad-btn dpad-left" data-button="LEFT"></button>
                        <button class="dpad-btn dpad-right" data-button="RIGHT"></button>
                      </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex justify-content-center">
                      <div class="action-buttons">
                        <button class="action-btn btn btn-circle btn-dark btn-back" data-button="BACK">
                          <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                            <circle cx="50" cy="50" r="46" />
                            <text x="50" y="56" text-anchor="middle">BACK</text>
                          </svg>
                        </button>
                        <button class="action-btn btn btn-circle btn-dark btn-ok" data-button="OK">
                          <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                            <circle cx="50" cy="50" r="46" />
                            <text x="50" y="56" text-anchor="middle">OK</text>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="card d-flex flex-column" style="height: 420px;">
                <div class="card-header">
                  <h3 class="card-title">
                    <span class="lucide-icon lucide-icon-logs" aria-hidden="true"></span>
                    Logs
                  </h3>
                </div>
                <div class="card-body p-0 flex-grow-1" style="min-height: 0;">
                  <div id="debug-log" class="list-group list-group-flush overflow-auto h-100"></div>
                </div>
                <div class="card-footer d-flex align-items-center pt-4 mt-auto">
                  <label class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" checked>
                    <span class="form-check-label">Auto-scroll</span>
                  </label>
                  <span class="text-muted small ms-auto">Logs appear here as events are recorded.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/static/tabler/tabler.min.js"></script>
  <script>
    const DEBUG_UI = true;

    const logFrame = document.getElementById('debug-log');
    const autoScrollToggle = document.getElementById('auto-scroll-toggle');
    let autoScrollEnabled = true;
    const levelBadgeClasses = {
      error: 'bg-danger',
      warn: 'bg-warning',
      debug: 'bg-primary',
      log: 'bg-secondary',
      info: 'bg-info'
    };

    function appendLog(level, message, details = {}, source = 'UI', timestamp = null, tags = null) {
      if (!logFrame) {
        return;
      }
      const entry = document.createElement('div');
      entry.className = 'list-group-item d-flex align-items-start gap-2';
      entry.dataset.source = source;
      const timestampValue = timestamp ?? new Date().toISOString();
      const payload = Object.keys(details).length ? ` ${JSON.stringify(details)}` : '';
      const prefix = source ? `[${source}] ` : '';
      const badge = document.createElement('span');
      const badgeClass = levelBadgeClasses[level] || 'bg-secondary';
      badge.className = `badge ${badgeClass} text-uppercase`;
      badge.textContent = level;
      const content = document.createElement('code');
      content.className = 'small';
      const timestampEl = document.createElement('span');
      timestampEl.className = 'text-muted';
      timestampEl.textContent = `[${timestampValue}] `;
      const messageEl = document.createElement('span');
      messageEl.textContent = `${prefix}${message}${payload}`;
      content.append(timestampEl, messageEl);
      if (Array.isArray(tags) && tags.length > 0) {
        const tagList = document.createElement('span');
        tagList.className = 'ms-2 d-inline-flex gap-1';
        tags.forEach((tag) => {
          const tagBadge = document.createElement('span');
          tagBadge.className = 'badge bg-azure-lt text-uppercase';
          tagBadge.textContent = String(tag);
          tagList.appendChild(tagBadge);
        });
        content.appendChild(tagList);
      }
      entry.append(badge, content);
      if (logFrame.childNodes.length === 1 && logFrame.textContent.includes('disabled')) {
        logFrame.textContent = '';
      }
      logFrame.appendChild(entry);
      if (autoScrollEnabled) {
        logFrame.scrollTop = logFrame.scrollHeight;
      }
    }

    function clearAppLogEntries() {
      if (!logFrame) {
        return;
      }
      logFrame.querySelectorAll('[data-source="APP"]').forEach((entry) => {
        entry.remove();
      });
    }

    function debugLog(level, message, details = {}) {
      const logger = console[level] || console.log;
      logger(message, {
        timestamp: new Date().toISOString(),
        ...details
      });
      appendLog(level, message, details, 'UI');
    }

    function socketDetails(socket, url, extra = {}) {
      return {
        url,
        readyState: socket ? socket.readyState : 'uninitialized',
        reconnectAttempts,
        ...extra
      };
    }

    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    const statusEl = document.getElementById('status');
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const screenSocketUrl = `${protocol}//${window.location.host}/ws/screen`;
    const controlSocketUrl = `${protocol}//${window.location.host}/ws/control`;
    const logSocketUrl = `${protocol}//${window.location.host}/ws/logs`;

    let screenSocket = null;
    let controlSocket = null;
    let logSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // Connect to screen WebSocket for display streaming
    function connectScreenSocket() {
      screenSocket = new WebSocket(screenSocketUrl);
      screenSocket.binaryType = 'arraybuffer';

      screenSocket.addEventListener('open', () => {
        debugLog('log', 'Screen WebSocket connected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
      });

      screenSocket.addEventListener('message', async (event) => {
        const blob = new Blob([event.data], { type: 'image/png' });
        const bitmap = await createImageBitmap(blob);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        if (typeof bitmap.close === 'function') {
          bitmap.close();
        }
      });

      screenSocket.addEventListener('close', () => {
        debugLog('warn', 'Screen WebSocket disconnected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
        setTimeout(connectScreenSocket, 2000);
      });

      screenSocket.addEventListener('error', (err) => {
        debugLog('error', 'Screen WebSocket error', socketDetails(screenSocket, screenSocketUrl, {
          error: err
        }));
      });
    }

    // Connect to control WebSocket for button presses
    function connectControlSocket() {
      controlSocket = new WebSocket(controlSocketUrl);

      controlSocket.addEventListener('open', () => {
        debugLog('log', 'Control WebSocket connected', socketDetails(controlSocket, controlSocketUrl));
        reconnectAttempts = 0;
        updateStatus();
      });

      controlSocket.addEventListener('close', () => {
        debugLog('warn', 'Control WebSocket disconnected', socketDetails(controlSocket, controlSocketUrl, {
          willReconnect: reconnectAttempts < maxReconnectAttempts
        }));
        updateStatus();
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          setTimeout(connectControlSocket, 2000);
        }
      });

      controlSocket.addEventListener('error', (err) => {
        debugLog('error', 'Control WebSocket error', socketDetails(controlSocket, controlSocketUrl, {
          error: err
        }));
      });
    }

    function handleLogEntries(entries) {
      if (!Array.isArray(entries)) {
        return;
      }
      entries.forEach((entry) => {
        if (typeof entry === 'string') {
          const trimmed = entry.trim();
          if (trimmed.length > 0) {
            appendLog('log', trimmed, {}, 'APP');
          }
          return;
        }
        if (entry && typeof entry === 'object') {
          const message = typeof entry.message === 'string' ? entry.message : JSON.stringify(entry);
          const level = entry.level || 'log';
          const tags = Array.isArray(entry.tags) ? entry.tags : [];
          const source = entry.source || 'APP';
          const timestamp = entry.timestamp || null;
          if (message.trim().length > 0) {
            appendLog(level, message, {}, source, timestamp, tags);
          }
        }
      });
    }

    function connectLogSocket() {
      logSocket = new WebSocket(logSocketUrl);

      logSocket.addEventListener('open', () => {
        debugLog('log', 'Log WebSocket connected', socketDetails(logSocket, logSocketUrl));
      });

      logSocket.addEventListener('message', (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (payload.type === 'snapshot' || payload.type === 'append') {
            if (payload.type === 'snapshot') {
              clearAppLogEntries();
            }
            handleLogEntries(payload.entries);
          } else if (payload.type === 'error') {
            debugLog('warn', 'Log WebSocket error payload', payload);
          }
        } catch (error) {
          debugLog('error', 'Failed to parse log payload', { error });
        }
      });

      logSocket.addEventListener('close', () => {
        debugLog('warn', 'Log WebSocket disconnected', socketDetails(logSocket, logSocketUrl));
        setTimeout(connectLogSocket, 2000);
      });

      logSocket.addEventListener('error', (err) => {
        debugLog('error', 'Log WebSocket error', socketDetails(logSocket, logSocketUrl, {
          error: err
        }));
      });
    }

    function updateStatus() {
      const screenConnected = screenSocket && screenSocket.readyState === WebSocket.OPEN;
      const controlConnected = controlSocket && controlSocket.readyState === WebSocket.OPEN;

      statusEl.className = 'nav-link d-flex align-items-center small';
      if (screenConnected && controlConnected) {
        statusEl.innerHTML = '<span class="status status-green"><span class="status-dot status-dot-animated"></span>Connected</span>';
      } else if (screenConnected || controlConnected) {
        statusEl.innerHTML = '<span class="status status-yellow"><span class="status-dot"></span>Partially Connected</span>';
      } else {
        statusEl.innerHTML = '<span class="status status-red"><span class="status-dot"></span>Disconnected</span>';
      }

      debugLog('debug', 'Status updated', {
        screenReadyState: screenSocket ? screenSocket.readyState : 'uninitialized',
        controlReadyState: controlSocket ? controlSocket.readyState : 'uninitialized',
        screenConnected,
        controlConnected
      });
    }

    // Send button press to the server
    function sendButtonPress(button) {
      if (controlSocket && controlSocket.readyState === WebSocket.OPEN) {
        controlSocket.send(JSON.stringify({ button: button }));
        debugLog('log', 'Button pressed', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      } else {
        debugLog('warn', 'Control socket not connected', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      }
    }

    // Add click handlers to all buttons
    document.querySelectorAll('[data-button]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });

      // Prevent text selection on touch devices
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });
    });

    if (autoScrollToggle) {
      autoScrollToggle.addEventListener('change', (event) => {
        autoScrollEnabled = event.target.checked;
      });
    }

    // Initialize connections
    connectScreenSocket();
    connectControlSocket();
    connectLogSocket();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rpi USB Cloner</title>

  <!-- Theme-aware SVG icons (modern browsers) -->
  <link rel="icon" href="/static/favicon/favicon.ico" sizes="any">
  <link rel="icon" href="/static/favicon/favicon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
  <link rel="icon" href="/static/favicon/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">

  <!-- Fallback PNG icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">

  <!-- Theme color for mobile browsers -->
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#111115" media="(prefers-color-scheme: dark)">

  <link rel="stylesheet" href="/static/tabler/tabler.min.css" />
  <style>
    @font-face {
      font-family: 'Lucide';
      src: url('/ui-assets/fonts/lucide.ttf') format('truetype');
      font-display: swap;
    }
    .lucide-icon {
      font-family: 'Lucide';
      font-size: 1.1em;
      line-height: 1;
    }
    .lucide-icon::before {
      display: inline-block;
    }
    .lucide-icon-tv::before {
      content: "\e203";
    }
    .lucide-icon-logs::before {
      content: "\e5f4";
    }
    .lucide-icon-copy-plus::before {
      content: "\e3fd";
    }
    .lucide-icon-activity::before {
      content: "\e038";
    }
    .lucide-icon-cpu::before {
      content: "\e0a9";
    }
    .lucide-icon-memory-stick::before {
      content: "\e445";
    }
    .lucide-icon-hard-drive::before {
      content: "\e0ed";
    }
    .lucide-icon-thermometer::before {
      content: "\e186";
    }
    .lucide-icon-github::before {
      content: "\e0e6";
    }
    .lucide-icon-sun::before {
      content: "\e178";
    }
    .lucide-icon-moon::before {
      content: "\e11e";
    }
    /* Dark mode logo styling */
    [data-bs-theme="dark"] .navbar-brand img {
      filter: invert(1) brightness(1.2);
    }
    /* D-pad on the left */
    .dpad-container {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .dpad-svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .dpad-cross {
      fill: #000;
    }
    .dpad-arrow {
      fill: #fff;
      transition: fill 0.15s ease;
    }
    .dpad-container:has(.dpad-up:hover) .dpad-arrow-up {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-down:hover) .dpad-arrow-down {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-left:hover) .dpad-arrow-left {
      fill: #ff4d4f;
    }
    .dpad-container:has(.dpad-right:hover) .dpad-arrow-right {
      fill: #ff4d4f;
    }
    .dpad-btn {
      position: absolute;
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .dpad-up {
      width: 60px;
      height: 70px;
      left: 60px;
      top: 0;
    }
    .dpad-down {
      width: 60px;
      height: 70px;
      left: 60px;
      bottom: 0;
    }
    .dpad-left {
      width: 70px;
      height: 60px;
      left: 0;
      top: 60px;
    }
    .dpad-right {
      width: 70px;
      height: 60px;
      right: 0;
      top: 60px;
    }
    /* Action buttons on the right */
    .action-buttons {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .btn-ok {
      position: absolute;
      top: 0;
      right: 0;
    }
    .btn-back {
      position: absolute;
      bottom: 0;
      left: 0;
    }
    .action-btn {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      padding: 0;
      background: transparent;
    }
    .action-btn svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .action-btn circle {
      fill: #000;
      transition: fill 0.15s ease, filter 0.15s ease;
    }
    .action-btn text {
      fill: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 0.5px;
      transition: fill 0.15s ease;
    }
    .action-btn:hover circle {
      fill: #000;
    }
    .action-btn:hover text {
      fill: #ff4d4f;
    }
    .action-btn:active circle {
      fill: #000;
    }
    #screen {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      border: 10px solid black;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="navbar navbar-expand-md d-print-none">
      <div class="container-xl">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#" aria-label="Rpi USB Cloner">
          <img src="/ui-assets/logo.svg" alt="" aria-hidden="true" class="navbar-brand-image">
          <span class="fw-semibold">Rpi USB CLONER</span>
        </a>
        <div class="navbar-nav flex-row order-md-last ms-auto align-items-center">
          <div class="nav-item">
            <button class="nav-link d-flex align-items-center btn btn-link p-0 border-0" id="theme-toggle" aria-label="Toggle theme">
              <span class="lucide-icon lucide-icon-sun" id="theme-icon" aria-hidden="true"></span>
            </button>
          </div>
          <div class="nav-item">
            <a class="nav-link d-flex align-items-center" href="https://github.com/2wenty2wo/Rpi-USB-Cloner" target="_blank" rel="noopener noreferrer" aria-label="View on GitHub">
              <span class="lucide-icon lucide-icon-github" aria-hidden="true"></span>
            </a>
          </div>
          <div class="nav-item">
            <span class="nav-link d-flex align-items-center small" id="status">
              <span class="status status-red"><span class="status-dot"></span>Disconnected</span>
            </span>
          </div>
        </div>
      </div>
    </header>
    <div class="page-wrapper">
      <div class="page-body">
        <div class="container-xl">
          <!-- System Health Card -->
          <div class="row row-cards mb-3">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title fw-semibold fs-4 d-flex align-items-center gap-2">
                    <span class="lucide-icon lucide-icon-activity" aria-hidden="true"></span>
                    System Health
                  </h3>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <!-- CPU Usage -->
                    <div class="col-12 col-sm-6 col-lg-3">
                      <div class="mb-1 d-flex align-items-center justify-content-between">
                        <small class="text-muted d-flex align-items-center gap-1">
                          <span class="lucide-icon lucide-icon-cpu" aria-hidden="true"></span>
                          CPU Usage
                        </small>
                        <span id="cpu-percent" class="fw-bold">--</span>
                      </div>
                      <div class="progress progress-sm">
                        <div id="cpu-bar" class="progress-bar w-0" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                    <!-- Memory Usage -->
                    <div class="col-12 col-sm-6 col-lg-3">
                      <div class="mb-1 d-flex align-items-center justify-content-between">
                        <small class="text-muted d-flex align-items-center gap-1">
                          <span class="lucide-icon lucide-icon-memory-stick" aria-hidden="true"></span>
                          Memory
                        </small>
                        <span id="memory-percent" class="fw-bold">--</span>
                      </div>
                      <div class="progress progress-sm">
                        <div id="memory-bar" class="progress-bar w-0" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small id="memory-detail" class="text-secondary">-- / -- MB</small>
                    </div>
                    <!-- Disk Usage -->
                    <div class="col-12 col-sm-6 col-lg-3">
                      <div class="mb-1 d-flex align-items-center justify-content-between">
                        <small class="text-muted d-flex align-items-center gap-1">
                          <span class="lucide-icon lucide-icon-hard-drive" aria-hidden="true"></span>
                          Disk Space
                        </small>
                        <span id="disk-percent" class="fw-bold">--</span>
                      </div>
                      <div class="progress progress-sm">
                        <div id="disk-bar" class="progress-bar w-0" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small id="disk-detail" class="text-secondary">-- / -- GB</small>
                    </div>
                    <!-- Temperature -->
                    <div class="col-12 col-sm-6 col-lg-3">
                      <div class="mb-1 d-flex align-items-center justify-content-between">
                        <small class="text-muted d-flex align-items-center gap-1">
                          <span class="lucide-icon lucide-icon-thermometer" aria-hidden="true"></span>
                          Temperature
                        </small>
                        <span id="temp-value" class="fw-bold">--</span>
                      </div>
                      <div class="progress progress-sm">
                        <div id="temp-bar" class="progress-bar w-0" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                      <small id="temp-detail" class="text-secondary">Raspberry Pi</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Preview and Logs Cards -->
          <div class="row row-cards">
            <div class="col-12 col-lg-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title fw-semibold fs-4 d-flex align-items-center gap-2">
                    <span class="lucide-icon lucide-icon-tv" aria-hidden="true"></span>
                    Preview
                  </h3>
                </div>
                <div class="card-body">
                  <div class="ratio ratio-2x1 mb-4">
                    <canvas id="screen" class="w-100 h-100 d-block" width="128" height="64"></canvas>
                  </div>
                  <div class="row g-4 align-items-center justify-content-between">
                    <div class="col-12 col-md-6 d-flex justify-content-center">
                      <div class="dpad-container">
                        <svg class="dpad-svg" viewBox="0 0 200 200" aria-hidden="true" focusable="false">
                          <path class="dpad-cross" d="M78 20h44a8 8 0 0 1 8 8v42h42a8 8 0 0 1 8 8v44a8 8 0 0 1-8 8h-42v42a8 8 0 0 1-8 8H78a8 8 0 0 1-8-8v-42H28a8 8 0 0 1-8-8V78a8 8 0 0 1 8-8h42V28a8 8 0 0 1 8-8z" />
                          <path class="dpad-arrow dpad-arrow-up" d="M100 38l12 20H88z" />
                          <path class="dpad-arrow dpad-arrow-down" d="M100 162l-12-20h24z" />
                          <path class="dpad-arrow dpad-arrow-left" d="M38 100l20-12v24z" />
                          <path class="dpad-arrow dpad-arrow-right" d="M162 100l-20 12V88z" />
                        </svg>
                        <button class="dpad-btn dpad-up" data-button="UP"></button>
                        <button class="dpad-btn dpad-down" data-button="DOWN"></button>
                        <button class="dpad-btn dpad-left" data-button="LEFT"></button>
                        <button class="dpad-btn dpad-right" data-button="RIGHT"></button>
                      </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex justify-content-center">
                      <div class="action-buttons">
                        <button class="action-btn btn btn-circle btn-dark btn-back" data-button="BACK">
                          <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                            <circle cx="50" cy="50" r="46" />
                            <text x="50" y="56" text-anchor="middle">BACK</text>
                          </svg>
                        </button>
                        <button class="action-btn btn btn-circle btn-dark btn-ok" data-button="OK">
                          <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                            <circle cx="50" cy="50" r="46" />
                            <text x="50" y="56" text-anchor="middle">OK</text>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="card h-100 d-flex flex-column">
                <div class="card-header">
                  <h3 class="card-title fw-semibold fs-4 d-flex align-items-center gap-2">
                    <span class="lucide-icon lucide-icon-logs" aria-hidden="true"></span>
                    Logs
                  </h3>
                </div>
                <div class="card-body p-0 scrollable" style="max-height: 18rem;">
                  <div id="debug-log" class="list-group list-group-flush w-100"></div>
                </div>
                <div class="card-footer d-flex align-items-center pt-4 mt-auto">
                  <label class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" checked>
                    <span class="form-check-label">Auto-scroll</span>
                  </label>
                  <span class="text-secondary small ms-auto">Logs appear here as events are recorded.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/static/tabler/tabler.min.js"></script>
  <script>
    // Theme toggle functionality
    (function() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const htmlElement = document.documentElement;

      // Get theme from localStorage or default to light
      function getStoredTheme() {
        return localStorage.getItem('theme') || 'light';
      }

      // Save theme to localStorage
      function setStoredTheme(theme) {
        localStorage.setItem('theme', theme);
      }

      // Apply theme to the document
      function applyTheme(theme) {
        htmlElement.setAttribute('data-bs-theme', theme);
        updateIcon(theme);
      }

      // Update the icon based on current theme
      function updateIcon(theme) {
        if (theme === 'dark') {
          themeIcon.className = 'lucide-icon lucide-icon-moon';
        } else {
          themeIcon.className = 'lucide-icon lucide-icon-sun';
        }
      }

      // Toggle between light and dark themes
      function toggleTheme() {
        const currentTheme = htmlElement.getAttribute('data-bs-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        setStoredTheme(newTheme);
      }

      // Initialize theme on page load
      const initialTheme = getStoredTheme();
      applyTheme(initialTheme);

      // Add click event listener to toggle button
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
    })();
  </script>
  <script>
    const DEBUG_UI = true;

    const logFrame = document.getElementById('debug-log');
    const autoScrollToggle = document.getElementById('auto-scroll-toggle');
    let autoScrollEnabled = true;
    const levelBadgeClasses = {
      error: 'bg-danger text-white',
      warn: 'bg-warning text-dark',
      debug: 'bg-primary text-white',
      log: 'bg-secondary text-white',
      info: 'bg-info text-dark'
    };

    // Format timestamp as relative time (e.g., "2 minutes ago")
    function formatRelativeTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);

      if (diffSec < 5) return 'just now';
      if (diffSec < 60) return `${diffSec}s ago`;
      if (diffMin < 60) return `${diffMin}m ago`;
      if (diffHr < 24) return `${diffHr}h ago`;
      if (diffDay === 1) return 'yesterday';
      if (diffDay < 7) return `${diffDay}d ago`;

      // For older logs, show date and time
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Parse and format message to be more human-readable
    function formatLogMessage(message, details, source) {
      // Try to parse JSON from message if present
      let parsedDetails = details || {};

      // Check if message is about button press (with details.button)
      if (message === 'Button pressed' && parsedDetails.button) {
        const button = parsedDetails.button;
        const icon = button === 'UP' ? 'â¬†ï¸' : button === 'DOWN' ? 'â¬‡ï¸' :
                     button === 'LEFT' ? 'â¬…ï¸' : button === 'RIGHT' ? 'âž¡ï¸' :
                     button === 'SELECT' || button === 'OK' ? 'âœ“' :
                     button === 'BACK' ? 'â—€ï¸' : 'ðŸ”˜';
        return {
          formatted: `${icon} Button: ${button}`,
          details: null,
          tags: []
        };
      }

      // Check if message contains button press info (e.g., "Button pressed: UP")
      const buttonMatch = message.match(/Button pressed:\s*(\w+)/);
      if (buttonMatch) {
        const button = buttonMatch[1];
        const icon = button === 'UP' ? 'â¬†ï¸' : button === 'DOWN' ? 'â¬‡ï¸' :
                     button === 'LEFT' ? 'â¬…ï¸' : button === 'RIGHT' ? 'âž¡ï¸' :
                     button === 'SELECT' || button === 'OK' ? 'âœ“' :
                     button === 'BACK' ? 'â—€ï¸' : 'ðŸ”˜';
        return {
          formatted: `${icon} Button: ${button}`,
          details: null,
          tags: []
        };
      }

      // Check if message contains button press info with JSON
      const buttonJsonMatch = message.match(/Button pressed\s*({.*})/);
      if (buttonJsonMatch) {
        try {
          const buttonData = JSON.parse(buttonJsonMatch[1]);
          const button = buttonData.button || 'unknown';
          const icon = button === 'UP' ? 'â¬†ï¸' : button === 'DOWN' ? 'â¬‡ï¸' :
                       button === 'LEFT' ? 'â¬…ï¸' : button === 'RIGHT' ? 'âž¡ï¸' :
                       button === 'SELECT' || button === 'OK' ? 'âœ“' :
                       button === 'BACK' ? 'â—€ï¸' : 'ðŸ”˜';
          return {
            formatted: `${icon} Button: ${button}`,
            details: null,
            tags: []
          };
        } catch (e) {
          // Fall through to default formatting
        }
      }

      // Check if message contains screen change info
      const screenMatch = message.match(/Screen changed:\s*(\w+)\s*->\s*(\w+)/);
      if (screenMatch) {
        const [, from, to] = screenMatch;
        return {
          formatted: `Screen: ${from} â†’ ${to}`,
          details: null,
          tags: ['NAVIGATION']
        };
      }

      // Check for WebSocket connection messages
      const wsMatch = message.match(/(Log|Screen|Control|Health)\s+WebSocket\s+(connected|disconnected|error)/i);
      if (wsMatch) {
        const [, wsType, status] = wsMatch;
        const icon = status === 'connected' ? 'ðŸŸ¢' : status === 'disconnected' ? 'ðŸ”´' : 'âš ï¸';
        return {
          formatted: `${icon} ${wsType} WebSocket ${status}`,
          details: null,
          tags: ['WEBSOCKET']
        };
      }

      // Check for socket not connected warnings
      if (message.includes('socket not connected')) {
        return {
          formatted: `âš ï¸ ${message}`,
          details: parsedDetails.button ? { button: parsedDetails.button } : null,
          tags: ['WARNING']
        };
      }

      // Default: return message as-is
      return {
        formatted: message,
        details: parsedDetails,
        tags: []
      };
    }

    function appendLog(level, message, details = {}, source = 'UI', timestamp = null, tags = null) {
      if (!logFrame) {
        return;
      }

      const entry = document.createElement('div');
      entry.className = 'list-group-item d-flex align-items-start gap-2 py-2';
      entry.dataset.source = source;

      const timestampValue = timestamp ?? new Date().toISOString();
      const formattedMsg = formatLogMessage(message, details, source);

      // Level badge - larger and more readable
      const badge = document.createElement('span');
      const badgeClass = levelBadgeClasses[level] || 'bg-secondary';
      badge.className = `badge badge-sm ${badgeClass} text-uppercase fw-bold text-center px-2`;
      badge.textContent = level;

      // Content wrapper
      const content = document.createElement('div');
      content.className = 'flex-grow-1';

      // Timestamp - relative time with tooltip showing exact time
      const timestampEl = document.createElement('span');
      timestampEl.className = 'text-secondary fs-7 lh-sm me-2';
      timestampEl.textContent = formatRelativeTime(timestampValue);
      timestampEl.dataset.timestamp = timestampValue;
      timestampEl.title = new Date(timestampValue).toLocaleString();

      // Source badge
      const sourceBadge = document.createElement('span');
      sourceBadge.className = 'badge badge-sm bg-secondary-lt text-secondary me-2';
      sourceBadge.textContent = source;

      // Message
      const messageEl = document.createElement('span');
      messageEl.className = 'fs-6';
      messageEl.textContent = formattedMsg.formatted;

      // First row: timestamp, source, message
      const firstRow = document.createElement('div');
      firstRow.className = 'd-flex align-items-center flex-wrap gap-1';
      firstRow.append(timestampEl, sourceBadge, messageEl);
      content.appendChild(firstRow);

      // Tags
      const allTags = [...formattedMsg.tags, ...(Array.isArray(tags) ? tags : [])];
      if (allTags.length > 0) {
        const tagList = document.createElement('div');
        tagList.className = 'mt-1 d-flex gap-1';
        allTags.forEach((tag) => {
          const tagBadge = document.createElement('span');
        tagBadge.className = 'badge badge-sm bg-azure-lt text-azure';
          tagBadge.textContent = String(tag);
          tagList.appendChild(tagBadge);
        });
        content.appendChild(tagList);
      }

      // Details - only show if not already parsed
      if (formattedMsg.details && Object.keys(formattedMsg.details).length > 0) {
        const detailsEl = document.createElement('div');
        detailsEl.className = 'mt-1 text-secondary fs-7 lh-sm font-monospace';

        // Format details in a more readable way
        const detailParts = [];
        for (const [key, value] of Object.entries(formattedMsg.details)) {
          if (key === 'url' || key === 'readyState' || key === 'reconnectAttempts') {
            continue; // Skip technical details already shown
          }
          detailParts.push(`${key}: ${JSON.stringify(value)}`);
        }
        if (detailParts.length > 0) {
          detailsEl.textContent = detailParts.join(', ');
          content.appendChild(detailsEl);
        }
      }

      entry.append(badge, content);

      if (logFrame.childNodes.length === 1 && logFrame.textContent.includes('disabled')) {
        logFrame.textContent = '';
      }
      logFrame.appendChild(entry);

      if (autoScrollEnabled) {
        logFrame.scrollTop = logFrame.scrollHeight;
      }
    }

    function clearAppLogEntries() {
      if (!logFrame) {
        return;
      }
      logFrame.querySelectorAll('[data-source="APP"]').forEach((entry) => {
        entry.remove();
      });
    }

    function debugLog(level, message, details = {}) {
      const logger = console[level] || console.log;
      logger(message, {
        timestamp: new Date().toISOString(),
        ...details
      });
      appendLog(level, message, details, 'UI');
    }

    function socketDetails(socket, url, extra = {}) {
      return {
        url,
        readyState: socket ? socket.readyState : 'uninitialized',
        reconnectAttempts,
        ...extra
      };
    }

    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    const statusEl = document.getElementById('status');
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const screenSocketUrl = `${protocol}//${window.location.host}/ws/screen`;
    const controlSocketUrl = `${protocol}//${window.location.host}/ws/control`;
    const logSocketUrl = `${protocol}//${window.location.host}/ws/logs`;
    const healthSocketUrl = `${protocol}//${window.location.host}/ws/health`;

    let screenSocket = null;
    let controlSocket = null;
    let logSocket = null;
    let healthSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // Connect to screen WebSocket for display streaming
    function connectScreenSocket() {
      screenSocket = new WebSocket(screenSocketUrl);
      screenSocket.binaryType = 'arraybuffer';

      screenSocket.addEventListener('open', () => {
        debugLog('log', 'Screen WebSocket connected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
      });

      screenSocket.addEventListener('message', async (event) => {
        const blob = new Blob([event.data], { type: 'image/png' });
        const bitmap = await createImageBitmap(blob);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        if (typeof bitmap.close === 'function') {
          bitmap.close();
        }
      });

      screenSocket.addEventListener('close', () => {
        debugLog('warn', 'Screen WebSocket disconnected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
        setTimeout(connectScreenSocket, 2000);
      });

      screenSocket.addEventListener('error', (err) => {
        debugLog('error', 'Screen WebSocket error', socketDetails(screenSocket, screenSocketUrl, {
          error: err
        }));
      });
    }

    // Connect to control WebSocket for button presses
    function connectControlSocket() {
      controlSocket = new WebSocket(controlSocketUrl);

      controlSocket.addEventListener('open', () => {
        debugLog('log', 'Control WebSocket connected', socketDetails(controlSocket, controlSocketUrl));
        reconnectAttempts = 0;
        updateStatus();
      });

      controlSocket.addEventListener('close', () => {
        debugLog('warn', 'Control WebSocket disconnected', socketDetails(controlSocket, controlSocketUrl, {
          willReconnect: reconnectAttempts < maxReconnectAttempts
        }));
        updateStatus();
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          setTimeout(connectControlSocket, 2000);
        }
      });

      controlSocket.addEventListener('error', (err) => {
        debugLog('error', 'Control WebSocket error', socketDetails(controlSocket, controlSocketUrl, {
          error: err
        }));
      });
    }

    function handleLogEntries(entries) {
      if (!Array.isArray(entries)) {
        return;
      }
      entries.forEach((entry) => {
        if (typeof entry === 'string') {
          const trimmed = entry.trim();
          if (trimmed.length > 0) {
            appendLog('log', trimmed, {}, 'APP');
          }
          return;
        }
        if (entry && typeof entry === 'object') {
          const message = typeof entry.message === 'string' ? entry.message : JSON.stringify(entry);
          const level = entry.level || 'log';
          const tags = Array.isArray(entry.tags) ? entry.tags : [];
          const source = entry.source || 'APP';
          const timestamp = entry.timestamp || null;
          if (message.trim().length > 0) {
            appendLog(level, message, {}, source, timestamp, tags);
          }
        }
      });
    }

    function connectLogSocket() {
      logSocket = new WebSocket(logSocketUrl);

      logSocket.addEventListener('open', () => {
        debugLog('log', 'Log WebSocket connected', socketDetails(logSocket, logSocketUrl));
      });

      logSocket.addEventListener('message', (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (payload.type === 'snapshot' || payload.type === 'append') {
            if (payload.type === 'snapshot') {
              clearAppLogEntries();
            }
            handleLogEntries(payload.entries);
          } else if (payload.type === 'error') {
            debugLog('warn', 'Log WebSocket error payload', payload);
          }
        } catch (error) {
          debugLog('error', 'Failed to parse log payload', { error });
        }
      });

      logSocket.addEventListener('close', () => {
        debugLog('warn', 'Log WebSocket disconnected', socketDetails(logSocket, logSocketUrl));
        setTimeout(connectLogSocket, 2000);
      });

      logSocket.addEventListener('error', (err) => {
        debugLog('error', 'Log WebSocket error', socketDetails(logSocket, logSocketUrl, {
          error: err
        }));
      });
    }

    // Connect to health WebSocket for system metrics
    function connectHealthSocket() {
      healthSocket = new WebSocket(healthSocketUrl);

      healthSocket.addEventListener('open', () => {
        debugLog('log', 'Health WebSocket connected', socketDetails(healthSocket, healthSocketUrl));
      });

      healthSocket.addEventListener('message', (event) => {
        try {
          const health = JSON.parse(event.data);
          updateHealthMetrics(health);
        } catch (error) {
          debugLog('error', 'Failed to parse health payload', { error });
        }
      });

      healthSocket.addEventListener('close', () => {
        debugLog('warn', 'Health WebSocket disconnected', socketDetails(healthSocket, healthSocketUrl));
        setTimeout(connectHealthSocket, 2000);
      });

      healthSocket.addEventListener('error', (err) => {
        debugLog('error', 'Health WebSocket error', socketDetails(healthSocket, healthSocketUrl, {
          error: err
        }));
      });
    }

    // Update health metrics in the UI
    function updateHealthMetrics(health) {
      // Update CPU
      if (health.cpu) {
        document.getElementById('cpu-percent').textContent = `${health.cpu.percent}%`;
        document.getElementById('cpu-bar').style.width = `${health.cpu.percent}%`;
        document.getElementById('cpu-bar').className = `progress-bar bg-${health.cpu.status}`;
      }

      // Update Memory
      if (health.memory) {
        document.getElementById('memory-percent').textContent = `${health.memory.percent}%`;
        document.getElementById('memory-bar').style.width = `${health.memory.percent}%`;
        document.getElementById('memory-bar').className = `progress-bar bg-${health.memory.status}`;
        document.getElementById('memory-detail').textContent = `${health.memory.used_mb} / ${health.memory.total_mb} MB`;
      }

      // Update Disk
      if (health.disk) {
        document.getElementById('disk-percent').textContent = `${health.disk.percent}%`;
        document.getElementById('disk-bar').style.width = `${health.disk.percent}%`;
        document.getElementById('disk-bar').className = `progress-bar bg-${health.disk.status}`;
        document.getElementById('disk-detail').textContent = `${health.disk.used_gb} / ${health.disk.total_gb} GB`;
      }

      // Update Temperature
      if (health.temperature && health.temperature.celsius !== null) {
        document.getElementById('temp-value').textContent = `${health.temperature.celsius}Â°C`;
        // Scale temperature: 0Â°C = 0%, 100Â°C = 100%
        const tempPercent = Math.min(100, Math.max(0, health.temperature.celsius));
        document.getElementById('temp-bar').style.width = `${tempPercent}%`;
        document.getElementById('temp-bar').className = `progress-bar bg-${health.temperature.status}`;
      } else {
        document.getElementById('temp-value').textContent = 'N/A';
        document.getElementById('temp-bar').style.width = '0%';
        document.getElementById('temp-detail').textContent = 'Not available';
      }
    }

    function updateStatus() {
      const screenConnected = screenSocket && screenSocket.readyState === WebSocket.OPEN;
      const controlConnected = controlSocket && controlSocket.readyState === WebSocket.OPEN;

      statusEl.className = 'nav-link d-flex align-items-center small';
      if (screenConnected && controlConnected) {
        statusEl.innerHTML = '<span class="status status-green"><span class="status-dot status-dot-animated"></span>Connected</span>';
      } else if (screenConnected || controlConnected) {
        statusEl.innerHTML = '<span class="status status-yellow"><span class="status-dot"></span>Partially Connected</span>';
      } else {
        statusEl.innerHTML = '<span class="status status-red"><span class="status-dot"></span>Disconnected</span>';
      }

      debugLog('debug', 'Status updated', {
        screenReadyState: screenSocket ? screenSocket.readyState : 'uninitialized',
        controlReadyState: controlSocket ? controlSocket.readyState : 'uninitialized',
        screenConnected,
        controlConnected
      });
    }

    // Send button press to the server
    function sendButtonPress(button) {
      if (controlSocket && controlSocket.readyState === WebSocket.OPEN) {
        controlSocket.send(JSON.stringify({ button: button }));
        debugLog('log', 'Button pressed', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      } else {
        debugLog('warn', 'Control socket not connected', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      }
    }

    // Add click handlers to all buttons
    document.querySelectorAll('[data-button]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });

      // Prevent text selection on touch devices
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });
    });

    if (autoScrollToggle) {
      autoScrollToggle.addEventListener('change', (event) => {
        autoScrollEnabled = event.target.checked;
      });
    }

    // Update relative timestamps every 30 seconds
    setInterval(() => {
      if (!logFrame) return;
      logFrame.querySelectorAll('.list-group-item').forEach((entry) => {
        const timestampEl = entry.querySelector('.text-muted[title]');
        if (timestampEl && timestampEl.dataset.timestamp) {
          timestampEl.textContent = formatRelativeTime(timestampEl.dataset.timestamp);
        }
      });
    }, 30000);

    // Initialize connections
    connectScreenSocket();
    connectControlSocket();
    connectLogSocket();
    connectHealthSocket();
  </script>
</body>
</html>

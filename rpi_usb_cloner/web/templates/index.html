<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rpi USB Cloner</title>
  <link rel="stylesheet" href="/static/tabler/tabler.min.css" />
  <style>
    body {
      min-height: 100vh;
    }
    .screen {
      width: 100%;
      aspect-ratio: 2 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .screen canvas {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      object-fit: contain;
    }
    /* D-pad on the left */
    .dpad-container {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .dpad-svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .dpad-cross {
      fill: #000;
    }
    .dpad-arrow {
      fill: #fff;
      transition: fill 0.15s ease;
    }
    .dpad-container:hover .dpad-arrow {
      fill: #ff4d4f;
    }
    .dpad-btn {
      position: absolute;
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .dpad-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .dpad-btn:active {
      background: rgba(255, 255, 255, 0.18);
    }
    .dpad-up {
      width: 60px;
      height: 70px;
      left: 60px;
      top: 0;
    }
    .dpad-down {
      width: 60px;
      height: 70px;
      left: 60px;
      bottom: 0;
    }
    .dpad-left {
      width: 70px;
      height: 60px;
      left: 0;
      top: 60px;
    }
    .dpad-right {
      width: 70px;
      height: 60px;
      right: 0;
      top: 60px;
    }
    /* Action buttons on the right */
    .action-buttons {
      position: relative;
      width: 180px;
      height: 180px;
    }
    .btn-ok {
      position: absolute;
      top: 0;
      right: 0;
    }
    .btn-back {
      position: absolute;
      bottom: 0;
      left: 0;
    }
    .action-btn {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      padding: 0;
      background: transparent;
    }
    .action-btn svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .action-btn circle {
      fill: #000;
      transition: fill 0.15s ease, filter 0.15s ease;
    }
    .action-btn text {
      fill: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 0.5px;
      transition: fill 0.15s ease;
    }
    .action-btn:hover circle {
      fill: #1a1a1a;
      filter: drop-shadow(0 2px 4px rgba(255, 255, 255, 0.12));
    }
    .action-btn:hover text {
      fill: #ff4d4f;
    }
    .action-btn:active circle {
      fill: #333;
    }
    .status {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: #888;
    }
    .status.connected {
      color: #4a9;
    }
    .status.disconnected {
      color: #c44;
    }
    #debug-log {
      min-height: 220px;
      max-height: 220px;
      overflow-y: auto;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 11px;
      line-height: 1.4;
      color: #d6deeb;
      white-space: pre-wrap;
    }
    .log-entry {
      margin: 0 0 6px;
    }
    .log-entry:last-child {
      margin-bottom: 0;
    }
    .log-entry.log-error {
      color: #ff8f8f;
    }
    .log-entry.log-warn {
      color: #ffd27d;
    }
    .log-entry.log-debug {
      color: #9ad0ff;
    }
  </style>
</head>
<body class="bg-dark text-white">
  <div class="container py-4">
    <div class="row g-4 justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="card bg-dark border border-secondary">
          <div class="card-body">
            <div class="card bg-dark border border-secondary mb-3">
              <div class="card-body p-3">
                <div class="screen">
                  <canvas id="screen" width="128" height="64"></canvas>
                </div>
              </div>
            </div>
            <div class="row g-4 justify-content-between align-items-center">
              <div class="col-12 col-md-6 d-flex justify-content-center">
                <div class="dpad-container">
                  <svg class="dpad-svg" viewBox="0 0 200 200" aria-hidden="true" focusable="false">
                    <path class="dpad-cross" d="M78 20h44a8 8 0 0 1 8 8v42h42a8 8 0 0 1 8 8v44a8 8 0 0 1-8 8h-42v42a8 8 0 0 1-8 8H78a8 8 0 0 1-8-8v-42H28a8 8 0 0 1-8-8V78a8 8 0 0 1 8-8h42V28a8 8 0 0 1 8-8z" />
                    <path class="dpad-arrow" d="M100 38l12 20H88z" />
                    <path class="dpad-arrow" d="M100 162l-12-20h24z" />
                    <path class="dpad-arrow" d="M38 100l20-12v24z" />
                    <path class="dpad-arrow" d="M162 100l-20 12V88z" />
                  </svg>
                  <button class="dpad-btn dpad-up" data-button="UP"></button>
                  <button class="dpad-btn dpad-down" data-button="DOWN"></button>
                  <button class="dpad-btn dpad-left" data-button="LEFT"></button>
                  <button class="dpad-btn dpad-right" data-button="RIGHT"></button>
                </div>
              </div>
              <div class="col-12 col-md-6 d-flex justify-content-center">
                <div class="action-buttons">
                  <button class="action-btn btn btn-circle btn-dark btn-back" data-button="BACK">
                    <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                      <circle cx="50" cy="50" r="46" />
                      <text x="50" y="56" text-anchor="middle">BACK</text>
                    </svg>
                  </button>
                  <button class="action-btn btn btn-circle btn-dark btn-ok" data-button="OK">
                    <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false">
                      <circle cx="50" cy="50" r="46" />
                      <text x="50" y="56" text-anchor="middle">OK</text>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="status" id="status">Connecting...</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-8">
        <div class="card bg-dark border border-secondary">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h2 class="h5 mb-0">Debug Logs</h2>
            </div>
            <div id="debug-log" class="bg-dark border border-secondary rounded p-2"></div>
            <div class="text-muted small mt-2">Logs appear here as events are recorded.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/static/tabler/tabler.min.js"></script>
  <script>
    const DEBUG_UI = true;

    const logFrame = document.getElementById('debug-log');

    function appendLog(level, message, details = {}, source = 'UI') {
      if (!logFrame) {
        return;
      }
      const entry = document.createElement('div');
      entry.className = `log-entry log-${level}`;
      entry.dataset.source = source;
      const timestamp = new Date().toISOString();
      const payload = Object.keys(details).length ? ` ${JSON.stringify(details)}` : '';
      const prefix = source ? `[${source}] ` : '';
      entry.textContent = `[${timestamp}] ${prefix}${message}${payload}`;
      if (logFrame.childNodes.length === 1 && logFrame.textContent.includes('disabled')) {
        logFrame.textContent = '';
      }
      logFrame.appendChild(entry);
      logFrame.scrollTop = logFrame.scrollHeight;
    }

    function clearAppLogEntries() {
      if (!logFrame) {
        return;
      }
      logFrame.querySelectorAll('.log-entry[data-source="APP"]').forEach((entry) => {
        entry.remove();
      });
    }

    function debugLog(level, message, details = {}) {
      const logger = console[level] || console.log;
      logger(message, {
        timestamp: new Date().toISOString(),
        ...details
      });
      appendLog(level, message, details, 'UI');
    }

    function socketDetails(socket, url, extra = {}) {
      return {
        url,
        readyState: socket ? socket.readyState : 'uninitialized',
        reconnectAttempts,
        ...extra
      };
    }

    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const screenSocketUrl = `${protocol}//${window.location.host}/ws/screen`;
    const controlSocketUrl = `${protocol}//${window.location.host}/ws/control`;
    const logSocketUrl = `${protocol}//${window.location.host}/ws/logs`;

    let screenSocket = null;
    let controlSocket = null;
    let logSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // Connect to screen WebSocket for display streaming
    function connectScreenSocket() {
      screenSocket = new WebSocket(screenSocketUrl);
      screenSocket.binaryType = 'arraybuffer';

      screenSocket.addEventListener('open', () => {
        debugLog('log', 'Screen WebSocket connected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
      });

      screenSocket.addEventListener('message', async (event) => {
        const blob = new Blob([event.data], { type: 'image/png' });
        const bitmap = await createImageBitmap(blob);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        if (typeof bitmap.close === 'function') {
          bitmap.close();
        }
      });

      screenSocket.addEventListener('close', () => {
        debugLog('warn', 'Screen WebSocket disconnected', socketDetails(screenSocket, screenSocketUrl));
        updateStatus();
        setTimeout(connectScreenSocket, 2000);
      });

      screenSocket.addEventListener('error', (err) => {
        debugLog('error', 'Screen WebSocket error', socketDetails(screenSocket, screenSocketUrl, {
          error: err
        }));
      });
    }

    // Connect to control WebSocket for button presses
    function connectControlSocket() {
      controlSocket = new WebSocket(controlSocketUrl);

      controlSocket.addEventListener('open', () => {
        debugLog('log', 'Control WebSocket connected', socketDetails(controlSocket, controlSocketUrl));
        reconnectAttempts = 0;
        updateStatus();
      });

      controlSocket.addEventListener('close', () => {
        debugLog('warn', 'Control WebSocket disconnected', socketDetails(controlSocket, controlSocketUrl, {
          willReconnect: reconnectAttempts < maxReconnectAttempts
        }));
        updateStatus();
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          setTimeout(connectControlSocket, 2000);
        }
      });

      controlSocket.addEventListener('error', (err) => {
        debugLog('error', 'Control WebSocket error', socketDetails(controlSocket, controlSocketUrl, {
          error: err
        }));
      });
    }

    function handleLogEntries(entries) {
      if (!Array.isArray(entries)) {
        return;
      }
      entries.forEach((entry) => {
        if (typeof entry === 'string' && entry.trim().length > 0) {
          appendLog('log', entry, {}, 'APP');
        }
      });
    }

    function connectLogSocket() {
      logSocket = new WebSocket(logSocketUrl);

      logSocket.addEventListener('open', () => {
        debugLog('log', 'Log WebSocket connected', socketDetails(logSocket, logSocketUrl));
      });

      logSocket.addEventListener('message', (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (payload.type === 'snapshot' || payload.type === 'append') {
            if (payload.type === 'snapshot') {
              clearAppLogEntries();
            }
            handleLogEntries(payload.entries);
          } else if (payload.type === 'error') {
            debugLog('warn', 'Log WebSocket error payload', payload);
          }
        } catch (error) {
          debugLog('error', 'Failed to parse log payload', { error });
        }
      });

      logSocket.addEventListener('close', () => {
        debugLog('warn', 'Log WebSocket disconnected', socketDetails(logSocket, logSocketUrl));
        setTimeout(connectLogSocket, 2000);
      });

      logSocket.addEventListener('error', (err) => {
        debugLog('error', 'Log WebSocket error', socketDetails(logSocket, logSocketUrl, {
          error: err
        }));
      });
    }

    function updateStatus() {
      const screenConnected = screenSocket && screenSocket.readyState === WebSocket.OPEN;
      const controlConnected = controlSocket && controlSocket.readyState === WebSocket.OPEN;

      if (screenConnected && controlConnected) {
        statusEl.textContent = 'Connected';
        statusEl.className = 'status connected';
      } else if (screenConnected || controlConnected) {
        statusEl.textContent = 'Partially Connected';
        statusEl.className = 'status';
      } else {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'status disconnected';
      }

      debugLog('debug', 'Status updated', {
        screenReadyState: screenSocket ? screenSocket.readyState : 'uninitialized',
        controlReadyState: controlSocket ? controlSocket.readyState : 'uninitialized',
        screenConnected,
        controlConnected
      });
    }

    // Send button press to the server
    function sendButtonPress(button) {
      if (controlSocket && controlSocket.readyState === WebSocket.OPEN) {
        controlSocket.send(JSON.stringify({ button: button }));
        debugLog('log', 'Button pressed', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      } else {
        debugLog('warn', 'Control socket not connected', socketDetails(controlSocket, controlSocketUrl, {
          button
        }));
      }
    }

    // Add click handlers to all buttons
    document.querySelectorAll('[data-button]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });

      // Prevent text selection on touch devices
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const button = btn.getAttribute('data-button');
        sendButtonPress(button);
      });
    });

    // Initialize connections
    connectScreenSocket();
    connectControlSocket();
    connectLogSocket();
  </script>
</body>
</html>
